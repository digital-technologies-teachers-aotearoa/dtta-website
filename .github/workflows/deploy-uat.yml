name: Deploy UAT

on:
  push:
    branches: ["main"]
    paths:
      - 'environments/uat.yml'

permissions:
  contents: read
  packages: read
  id-token: write

concurrency:
  group: deploy-uat
  cancel-in-progress: false

jobs:
  deploy-uat:
    name: Deploy image to UAT
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Read tag (django key from YAML)
        id: tag
        run: |
          set -euo pipefail
          tag=$(yq -r '.django' environments/uat.yml)
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "django key missing or empty in environments/uat.yml" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate image exists
        run: |
          set -euo pipefail
          image="ghcr.io/digital-technologies-teachers-aotearoa/ams-django:${{ steps.tag.outputs.tag }}"
          if ! docker pull "$image"; then
            echo "Image $image not found" >&2
            exit 1
          fi

      - name: Deploy to DigitalOcean App Platform (UAT)
        uses: digitalocean/app_action/deploy@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_DEPLOY_TOKEN }}
          app_name: dtta-uat-website
          print_build_logs: true
          print_deploy_logs: true
        env:
          IMAGE_DIGEST_DJANGO: ghcr.io/digital-technologies-teachers-aotearoa/ams-django:${{ steps.tag.outputs.tag }}

      - name: Summary
        run: |
          echo "Deployed UAT tag: ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
