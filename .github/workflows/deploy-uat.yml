name: Deploy UAT

on:
  push:
    branches: ["main"]
    paths:
      - 'environments/uat/*'
      - '.github/workflows/deploy-uat.yml'

permissions:
  contents: read
  packages: read
  id-token: write

concurrency:
  group: deploy-uat
  cancel-in-progress: false

jobs:
  deploy-uat:
    name: Deploy image to UAT
    environment: UAT
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Read tag (ams key from YAML)
        id: tag
        run: |
          set -euo pipefail
          tag=$(yq -r '.ams' environments/uat/versions.yml)
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "ams key missing or empty in environments/uat/versions.yml" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate image exists
        run: |
          set -euo pipefail
          image="ghcr.io/digital-technologies-teachers-aotearoa/ams-django:${{ steps.tag.outputs.tag }}"
          if ! docker pull "$image"; then
            echo "Image $image not found" >&2
            exit 1
          fi

      - name: Deploy to DigitalOcean App Platform (UAT)
        uses: digitalocean/app_action/deploy@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_DEPLOY_TOKEN }}
          project_id: dtta-uat
          app_spec_location: environments/uat/app.yml
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DJANGO_ADMIN_URL: ${{ secrets.DJANGO_ADMIN_URL }}
          DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}
          MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
          MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }}
          MAILGUN_API_URL: ${{ secrets.MAILGUN_API_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          AMS_BILLING_SERVICE_CLASS: ${{ secrets.AMS_BILLING_SERVICE_CLASS }}
          AMS_BILLING_EMAIL_WHITELIST_REGEX: ${{ secrets.AMS_BILLING_EMAIL_WHITELIST_REGEX }}
          DISCOURSE_REDIRECT_DOMAIN: ${{ secrets.DISCOURSE_REDIRECT_DOMAIN }}
          DISCOURSE_CONNECT_SECRET: ${{ secrets.DISCOURSE_CONNECT_SECRET }}
          registry_credentials: ${{ secrets.REGISTRY_CREDENTIALS }}
          django_tag: ${{ steps.tag.outputs.tag }}

      - name: Summary
        run: |
          echo "Deployed UAT AMS: ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
